<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <title>Face Recognition Based Attendance System</title>
</head>

<body class="bg-white">

    <div class='mt-5 text-center'>
        <h1 class="text-primary fw-bold">Face Recognition Based Attendance System - {{ algo }}</h1>
    </div>

    {% if mess %}
    <p class="text-center text-danger fs-4">{{ mess }}</p>
    {% endif %}

    <div class="container mt-4">
        <div class="row g-4">

            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-danger text-white">
                        <h2>Today's Attendance <i class="material-icons">assignment</i></h2>
                    </div>
                    <div class="card-body">
                        <h5>Detection Capture</h5>
                        <div style="position: relative;">
                            <video id="video2" width="100%" height="auto" autoplay></video>
                            <canvas id="canvas2" width="100%" height="auto" style="position: absolute; top: 0; left: 0;"></canvas>
                        </div>
                        <a href="/start" class="btn btn-primary btn-lg w-100 mb-3">Take Attendance <i
                                class="material-icons">beenhere</i></a>

                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>No</th>
                                    <th>Staff Name</th>
                                    <th>Staff ID</th>
                                    <th>Time in/out</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if l %}
                                {% for i in range(l) %}
                                <tr>
                                    <td>{{ i+1 }}</td>
                                    <td>{{ names[i] }}</td>
                                    <td>{{ rolls[i] }}</td>
                                    <td>{{ times[i] }}</td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-danger text-white">
                        <h2>Register New Model <i class="material-icons">camera_alt</i></h2>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <input type="text" id="staff-name" class="form-control" placeholder="Staff Name" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" id="staff-id" class="form-control" placeholder="Staff ID" required>
                        </div>
                        <button class="btn btn-primary" id="register-btn" data-bs-toggle="modal" data-bs-target="#captureModal">Register New Model</button>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-info" id="show-users">Show Users</button>
                        <h5>Total Users in Database: {{totalreg}}</h5>
                    </div>
                </div>
            </div>
        </div>

        {% if facereco == False %}
        <div class="text-center mt-5">
            <button class="btn btn-success btn-lg" id="train-btn">Train Model <i class="material-icons">build</i></button>
        </div>

        <!-- Progress Section -->
        <div id="progress-section">
            <p>Training Progress: <span id="progress-value">0</span>%</p>
            <div id="progress-bar" style="width: 100%; background-color: #f3f3f3;">
                <div id="progress-fill" style="width: 0%; height: 20px; background-color: #4caf50;"></div>
            </div>
            <p id="completion-message" style="color: green; display: none;">Training completed successfully!</p>
        </div>
        {% elif facereco == True %}
        <div class="text-center mt-5">
            <button class="btn btn-success btn-lg" id="reload-btn">Reload Dataset <i class="material-icons">build</i></button>
        </div>
        
        <!-- Progress Section -->
        <div id="progress-section" style="display: none;">
            <p>Reloading Progress: <span id="progress-value">0</span>%</p>
            <div id="progress-bar" style="width: 100%; background-color: #f3f3f3;">
                <div id="progress-fill" style="width: 0%; height: 20px; background-color: #4caf50;"></div>
            </div>
            <p id="completion-message" style="color: green; display: none;">Reload completed successfully!</p>
        </div>
        {% endif %}
    </div>

    <!-- Modal for capturing video -->
    <div class="modal fade" id="captureModal" tabindex="-1" aria-labelledby="captureModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="captureModalLabel">Capture Image for New Model</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <video id="video" width="100%" height="auto" autoplay></video>
                    <img id="preview" src="" alt="Captured Image" style="display: none; width: 100%; height: auto;" />
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary" id="capture-btn">Capture Image <i class="material-icons">camera</i></button>
                    </div>
                </div>                
            </div>
        </div>
    </div>

    <!-- Modal for displaying users -->
    <div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="usersModalLabel">Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul id="user-list" class="list-group">
                        <!-- User names will be populated here -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize video stream for the main camera
        const video = document.getElementById('video');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing the camera: ", err);
            });

        // Capture image functionality for the modal camera
        $('#capture-btn').on('click', function() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');

            // Capture a single image
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imgData = canvas.toDataURL('image/png');

            // Show the captured image in the modal
            $('#preview').attr('src', imgData).show();

            const staffName = $('#staff-name').val();
            const staffId = $('#staff-id').val();

            // Send imgData to the server or handle it as needed
            $.post('/add', { image: imgData, staff_name: staffName, staff_id: staffId }, function(response) {
                console.log(response.message);
                $('#captureModal').modal('hide'); // Close modal after capture
                $('#staff-name').val(''); // Clear the staff name input
                $('#staff-id').val(''); // Clear the staff ID input
            });
        });

        // Initialize video stream for the detection capture
        const video2 = document.getElementById('video2');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video2.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing the camera: ", err);
            });

        // Event listener for showing users
        $('#show-users').on('click', function() {
            $.get('/get_users', function(users) {
                $('#user-list').empty();
                users.forEach(user => {
                    $('#user-list').append(`<li class="list-group-item">${user}</li>`);
                });
                $('#usersModal').modal('show');
            });
        });

        // Train model button click event
        $('#train-btn').on('click', function() {
            $.post('/train', function(response) {
                const interval = setInterval(() => {
                    $.get('/training_progress', function(progress) {
                        $('#progress-value').text(progress.value);
                        $('#progress-fill').css('width', progress.value + '%');
                        if (progress.value >= 100) {
                            clearInterval(interval);
                            $('#completion-message').show();
                        }
                    });
                }, 1000);
            });
        });

        // Reload dataset button click event
        $('#reload-btn').on('click', function() {
            $('#progress-section').show();
            $.post('/reload', function(response) {
                const interval = setInterval(() => {
                    $.get('/reload_progress', function(progress) {
                        $('#progress-value').text(progress.value);
                        $('#progress-fill').css('width', progress.value + '%');
                        if (progress.value >= 100) {
                            clearInterval(interval);
                            $('#completion-message').show();
                        }
                    });
                }, 1000);
            });
        });
    </script>
</body>

</html>

